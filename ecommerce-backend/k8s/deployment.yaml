apiVersion: apps/v1
kind: Deployment
metadata:
  name: ecommerce-web
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ecommerce-web
  template:
    metadata:
      labels:
        app: ecommerce-web
    spec:
      containers:
        - name: web
          image: your-docker-registry/ecommerce-web:latest
          ports:
            - containerPort: 8000
          envFrom:
            - configMapRef:
                name: ecommerce-config
            - secretRef:
                name: ecommerce-secrets
          command: ["gunicorn", "ecommerce.wsgi:application", "--bind", "0.0.0.0:8000"]
---
apiVersion: v1
kind: Service
metadata:
  name: ecommerce-web
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: 8000
  selector:
    app: ecommerce-web
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ecommerce-celery
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ecommerce-celery
  template:
    metadata:
      labels:
        app: ecommerce-celery
    spec:
      containers:
        - name: celery
          image: your-docker-registry/ecommerce-web:latest
          command: ["celery", "-A", "ecommerce", "worker", "--loglevel=info"]
          envFrom:
            - configMapRef:
                name: ecommerce-config
            - secretRef:
                name: ecommerce-secrets
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ecommerce-celery-beat
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ecommerce-celery-beat
  template:
    metadata:
      labels:
        app: ecommerce-celery-beat
    spec:
      containers:
        - name: celery-beat
          image: your-docker-registry/ecommerce-web:latest
          command:
            [
              "celery",
              "-A",
              "ecommerce",
              "beat",
              "--loglevel=info",
              "--scheduler",
              "django_celery_beat.schedulers:DatabaseScheduler",
            ]
          envFrom:
            - configMapRef:
                name: ecommerce-config
            - secretRef:
                name: ecommerce-secrets
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ecommerce-config
data:
  DJANGO_SETTINGS_MODULE: ecommerce.settings
  DEBUG: "false"
  ALLOWED_HOSTS: "*"
  DB_ENGINE: django.db.backends.postgresql
  DB_NAME: ecommerce
  DB_USER: ecommerce
  DB_HOST: postgres
  DB_PORT: "5432"
  REDIS_URL: redis://redis:6379/0
  RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672//
---
apiVersion: v1
kind: Secret
metadata:
  name: ecommerce-secrets
type: Opaque
stringData:
  DJANGO_SECRET_KEY: your-secret-key
  DB_PASSWORD: your-db-password
  MPESA_CONSUMER_KEY: your-mpesa-consumer-key
  MPESA_CONSUMER_SECRET: your-mpesa-consumer-secret
  MPESA_PASSKEY: your-mpesa-passkey